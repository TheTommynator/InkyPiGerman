<!-- Leaflet (Map) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  #dd-map {
    height: 280px;
    border-radius: 12px;
    border: 1px solid #d0d0d0;
    margin-top: 10px;
    overflow: hidden;
  }
  .dd-map-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .dd-hint {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 6px;
  }
  .dd-locline {
    margin-top: 8px;
    font-size: 13px;
    opacity: 0.9;
  }
</style>

<div class="form-group">
  <label class="form-label">Standort ausw√§hlen (Karte):</label>

  <div class="dd-map-row">
    <div>
      <label class="form-label" for="latitude">Breitengrad:</label>
      <input id="latitude" name="latitude" class="form-input" type="text" placeholder="50.1109" />
    </div>
    <div>
      <label class="form-label" for="longitude">L√§ngengrad:</label>
      <input id="longitude" name="longitude" class="form-input" type="text" placeholder="8.6821" />
    </div>
  </div>

  <div id="dd-map"></div>

  <div class="dd-hint">
    Tipp: Klick auf die Karte setzt den Marker. Du kannst auch Lat/Lon manuell eintippen.
  </div>
  <div id="dd-location" class="dd-locline"></div>
</div>

<hr />

<div class="form-group">
  <label class="form-label" for="units">Einheiten:</label>
  <select id="units" name="units" class="form-input">
    <option value="metric" selected>Metrisch (¬∞C)</option>
    <option value="imperial">Imperial (¬∞F)</option>
    <option value="standard">Standard (K)</option>
  </select>
</div>

<hr />

<div class="form-group">
  <label class="form-label" for="rss_url">RSS-URL:</label>
  <input id="rss_url" name="rss_url" class="form-input" type="text" placeholder="https://‚Ä¶" />
</div>

<div class="form-group">
  <label class="form-label" for="rss_count">Anzahl News (1‚Äì5):</label>
  <input id="rss_count" name="rss_count" class="form-input" type="number" min="1" max="5" value="3" />
</div>

<hr />

<div class="form-group">
  <label class="form-label" for="accent_color">Akzentfarbe:</label>
  <select id="accent_color" name="accent_color" class="form-input">
    <option value="#000000">Schwarz</option>
    <option value="#FFFFFF">Wei√ü</option>
    <option value="#FF0000">Rot</option>
    <option value="#FFFF00">Gelb</option>
    <option value="#0000FF" selected>Blau</option>
    <option value="#00FF00">Gr√ºn</option>
    <option value="#FFA500">Orange</option>
  </select>
</div>

<div class="form-group">
  <label class="form-label" for="panel_bg">Panel-Hintergrund:</label>
  <select id="panel_bg" name="panel_bg" class="form-input">
    <option value="none" selected>Keiner (transparent)</option>
    <option value="#FFFFFF">Wei√ü</option>
    <option value="#000000">Schwarz</option>
    <option value="#FF0000">Rot</option>
    <option value="#FFFF00">Gelb</option>
    <option value="#0000FF">Blau</option>
    <option value="#00FF00">Gr√ºn</option>
    <option value="#FFA500">Orange</option>
  </select>
</div>

<div class="form-group">
  <label class="form-label" for="frame">Rahmen:</label>
  <select id="frame" name="frame" class="form-input">
    <option value="none" selected>Kein Rahmen</option>
    <option value="thin">D√ºnn</option>
    <option value="thick">Dick</option>
  </select>
</div>

<div class="form-group">
  <label class="form-label" for="frame_color">Rahmenfarbe:</label>
  <select id="frame_color" name="frame_color" class="form-input">
    <option value="#000000" selected>Schwarz</option>
    <option value="#FFFFFF">Wei√ü</option>
    <option value="#FF0000">Rot</option>
    <option value="#FFFF00">Gelb</option>
    <option value="#0000FF">Blau</option>
    <option value="#00FF00">Gr√ºn</option>
    <option value="#FFA500">Orange</option>
  </select>
</div>

<hr />

<div class="form-group">
  <label class="form-label" for="title_font">Titel-Schriftart:</label>
  <select id="title_font" name="title_font" class="form-input">
    <option value="Inter" selected>Inter</option>
    <option value="Roboto">Roboto</option>
    <option value="Helvetica">Helvetica</option>
    <option value="Arial">Arial</option>
  </select>
</div>

<div class="form-group">
  <label class="form-label" for="body_font">Text-Schriftart:</label>
  <select id="body_font" name="body_font" class="form-input">
    <option value="Inter" selected>Inter</option>
    <option value="Roboto">Roboto</option>
    <option value="Helvetica">Helvetica</option>
    <option value="Arial">Arial</option>
  </select>
</div>

<div class="form-group">
  <label class="form-label" for="title_size">Titel-Gr√∂√üe:</label>
  <input id="title_size" name="title_size" class="form-input" type="number" min="20" max="120" value="56" />
</div>

<div class="form-group">
  <label class="form-label" for="body_size">Text-Gr√∂√üe:</label>
  <input id="body_size" name="body_size" class="form-input" type="number" min="14" max="60" value="28" />
</div>

<script>
  // ---------- Helpers ----------
  function toNum(v) {
    const n = parseFloat(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : null;
  }

  async function reverseGeocode(lat, lon) {
    const outEl = document.getElementById("dd-location");
    if (!outEl) return;

    outEl.textContent = "Ort wird geladen‚Ä¶";

    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("Reverse-Geocoding fehlgeschlagen");
      const data = await res.json();
      outEl.textContent = data.display_name ? `üìç ${data.display_name}` : "";
    } catch (e) {
      // Wenn Nominatim blockt / offline ist: einfach still bleiben
      outEl.textContent = "";
    }
  }

  // ---------- Prepopulate ----------
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof loadPluginSettings !== "undefined" && loadPluginSettings) {
      const s = pluginSettings;

      latitude.value = s.latitude || "";
      longitude.value = s.longitude || "";
      units.value = s.units || "metric";

      rss_url.value = s.rss_url || "";
      rss_count.value = s.rss_count || 3;

      accent_color.value = s.accent_color || "#0000FF";
      panel_bg.value = s.panel_bg || "none";
      frame.value = s.frame || "none";
      frame_color.value = s.frame_color || "#000000";

      title_font.value = s.title_font || "Inter";
      body_font.value = s.body_font || "Inter";
      title_size.value = s.title_size || 56;
      body_size.value = s.body_size || 28;
    }

    // ---------- Map init ----------
    // Default: Frankfurt, falls leer
    const lat0 = toNum(latitude.value) ?? 50.1109;
    const lon0 = toNum(longitude.value) ?? 8.6821;

    const map = L.map("dd-map", { zoomControl: true }).setView([lat0, lon0], 10);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    let marker = L.marker([lat0, lon0], { draggable: true }).addTo(map);

    function setLatLon(lat, lon, updateMap = true) {
      latitude.value = String(lat.toFixed(6));
      longitude.value = String(lon.toFixed(6));
      if (updateMap) {
        marker.setLatLng([lat, lon]);
      }
      reverseGeocode(lat, lon);
    }

    // Klick setzt Marker
    map.on("click", (e) => {
      setLatLon(e.latlng.lat, e.latlng.lng, true);
    });

    // Drag setzt Felder
    marker.on("dragend", () => {
      const pos = marker.getLatLng();
      setLatLon(pos.lat, pos.lng, false);
    });

    // Manuelles Tippen -> Marker aktualisieren
    function syncFromInputs() {
      const la = toNum(latitude.value);
      const lo = toNum(longitude.value);
      if (la == null || lo == null) return;
      marker.setLatLng([la, lo]);
      map.setView([la, lo], map.getZoom());
      reverseGeocode(la, lo);
    }

    latitude.addEventListener("change", syncFromInputs);
    longitude.addEventListener("change", syncFromInputs);

    // initial reverse lookup
    reverseGeocode(lat0, lon0);
  });
</script>